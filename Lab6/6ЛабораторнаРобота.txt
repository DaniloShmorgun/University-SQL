use[Облік виданих позик]
go

insert into Повернення_позик (код_клієнта, дата_платежу, розмір_платежу) values (320, 23-10-2021,243);

select * from ПоточніБорги;


create view ПоточніБорги
as
select кл1.код_клієнта [код_клієнта], кл2.код_позики[код_позики], [дата_останнього_платежу], [залишилось виплатити]
from Повернення_позик кл1
inner join Клієнти кл2
on кл1.код_клієнта = кл2.код_клієнта
inner join (select max(Повернення_позик.дата_платежу)[дата_останнього_платежу], код_клієнта from Повернення_позик group by код_клієнта) дата
on кл1.дата_платежу = дата.дата_останнього_платежу and кл1.код_клієнта = дата.код_клієнта
inner join (select (кл5.розмір_позики - кр.[сума_виплатів_клієнта])[залишилось виплатити], кл5.код_клієнта from Клієнти кл5
inner join (select sum(фр.розмір_платежу)[сума_виплатів_клієнта], фр.код_клієнта from Повернення_позик фр group by фр.код_клієнта) кр on
кл5.код_клієнта = кр.код_клієнта ) 
клієнт
on кл1.код_клієнта = клієнт.код_клієнта
with check option