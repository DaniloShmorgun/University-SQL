use [Облік виданих позик]
go

create proc Вчасні_клієнти
as
begin 
if TRIGGER_NESTLEVEL() > 1
return 
select клієнти.ПІП_клієнта
from Клієнти клієнти
inner join КлієнтиЗВчасноВиплаченимиПозиками клієнти2
on клієнти.ІД_код = клієнти2.ІД_код 
and клієнти2.[Кількість позик у клієнта] - клієнти2.[Кількість вчасно виплачених позик] = 0 
end

exec Вчасні_клієнти;


create proc Вчасні_клієнти
as
select клієнти.ПІП_клієнта
from Клієнти клієнти
inner join КлієнтиЗВчасноВиплаченимиПозиками клієнти2
on клієнти.ІД_код = клієнти2.ІД_код 
and клієнти2.[Кількість позик у клієнта] - клієнти2.[Кількість вчасно виплачених позик] = 0

create view ВчасноВиплаченіПозики
as
select ІД_код, клієнти.код_клієнта, [ВчасноВиплачена] =
case when (GETDATE() < клієнти.дата_закінчення_договору and клієнти.позика_погашена = 0)
OR (клієнти.позика_погашена = 1 and клієнти.дата_закінчення_договору > борги.дата_останнього_платежу)
THEN 1
ELSE 0
end
from Клієнти клієнти
inner join ПоточніБорги борги
on клієнти.код_клієнта = борги.код_клієнта

create view КлієнтиЗВчасноВиплаченимиПозиками
as
select ІД_код, count(ІД_код)[Кількість позик у клієнта], sum(ВчасноВиплачена)[Кількість вчасно виплачених позик]
from ВчасноВиплаченіПозики
group by ІД_код
